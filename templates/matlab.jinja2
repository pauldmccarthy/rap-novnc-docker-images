########
# MATLAB
########

# Gratefully pilfered from the following official Matlab docker image resources:
#  - https://github.com/mathworks-ref-arch/container-images/tree/main/matlab-deps/r2025b/ubuntu24.04
#  - https://github.com/mathworks-ref-arch/container-images/blob/main/matlab/Dockerfile

{{ apt_install(
        'apt-utils',
        'ca-certificates',
        'debianutils',
        'gcc-12',
        'g++-12',
        'ibverbs-providers',
        'libasound2t64',
        'libatk-bridge2.0-0t64',
        'libatk1.0-0t64',
        'libatomic1',
        'libatspi2.0-0t64',
        'libc6',
        'libcairo-gobject2',
        'libcairo2',
        'libcap2',
        'libcrypt1',
        'libcups2t64',
        'libdrm2',
        'libfontconfig1',
        'libfribidi0',
        'libgbm1',
        'libgdk-pixbuf-2.0-0',
        'libgl1',
        'libglib2.0-0t64',
        'libgstreamer-plugins-base1.0-0',
        'libgstreamer1.0-0',
        'libgtk-3-0t64',
        'libibverbs1',
        'libice6',
        'libltdl7',
        'libnspr4',
        'libnss3',
        'libnuma1',
        'libpam0g',
        'libpango-1.0-0',
        'libpangocairo-1.0-0',
        'libpangoft2-1.0-0',
        'libpixman-1-0',
        'libpsm2-2',
        'librdmacm1t64',
        'libsndfile1',
        'libtirpc3t64',
        'libucx0',
        'libuhd4.6.0-dpdk',
        'libuuid1',
        'libxcomposite1',
        'libxcursor1',
        'libxdamage1',
        'libxfixes3',
        'libxfont2',
        'libxft2',
        'libxinerama1',
        'libxrandr2',
        'libxt6t64',
        'libxtst6',
        'libxxf86vm1',
        'locales',
        'locales-all',
        'make',
        'net-tools',
        'procps',
        'sudo',
        'unzip',
        'wget',
        'x11-xkb-utils',
        'zlib1g') }}

RUN ln -s $(which gcc-12) /usr/bin/gcc && \
    ln -s $(which g++-12) /usr/bin/g++

# MATLAB itself
RUN cd /tmp/                                            && \
    curl -LsO https://www.mathworks.com/mpm/glnxa64/mpm && \
    chmod +x mpm                                        && \
    ./mpm install                                          \
        --release=r2025b                                   \
        --destination=/opt/MATLAB                          \
        --products "MATLAB"                             && \
    rm -f /opt/MATLAB/sys/os/glnxa64/libstdc++.*        && \
    rm -f mpm mathworks_root.log                        && \
    echo 'export PATH=/opt/MATLAB/bin:$PATH' >> /root/.bashrc

# Matlab Service Host
RUN MSHURL=https://www.mathworks.com/MathWorksServiceHost/glnxa64/install_managed_msh.sh; \
    cd /tmp/                                       && \
    curl  -Ls  ${MSHURL} > msh                     && \
    chmod +x ./msh                                 && \
    ./msh --destination /opt/Mathworks/ServiceHost && \
    rm ./msh

{{ install_launcher(
     'MATLAB',
     '/opt/MATLAB/bin/matlab -desktop',
     '/opt/MATLAB/bin/glnxa64/cef_resources/matlab_icon.png') }}
